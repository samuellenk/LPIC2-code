---
title: "Praxis-Beispiel: Logical Volume Manager ![](images/LPIC2_logo.png){width=20 height=20}"
subtitle: "LPIC 2"
author: "![SL](images/SL_foto_300.png){width=20 height=20} [&copy; Samuel Lenk](https://linux-trainings.de/)"
theme: "Luebeck"
colortheme: "whale"
aspectratio: 169
colorlinks: true
urlcolor: gray
linkcolor: gray
---

# Einleitung

Diese Übung enthält ein vollständiges Beispiel zur Nutzung von LVM (Abschnitt 204.3).

# Voraussetzungen

- für das Nachvollziehen der Beispiele bietet sich eine VM an, der man mehrere Platten hinzufügen kann
- alternativ kannst du auch eine Festplatte einsetzen, auf der du mehrere Partitionen erstellst

# Vorbereitung

- im Hypervisor jetzt zwei weitere Platten hinzufügen

Ergebnis prüfen mit:
```bash
lsblk
```

- wir werden in dem Beispiel `/home` umziehen in ein LVM-Setup
- daher werden alle Befehle in einer Root-Shell ausgeführt
- falls du vorhandene Daten übernehmen möchtest, kannst du alles aus `/home` als `.tgz` sichern, dann das Backup verifizieren und danach den `/home` leer machen

# Installation und Konfiguration

Installation vom Paket für LVM:
```bash
apt install lvm2
```

Übersicht der Befehle:
```bash
ls -l /usr/sbin/{[lp]v,vg}*
```

- Befehle sind konsistent benannt
- und zeigen meist als Symlinks auf `lvm`

allgemeine Settings für LVM lassen sich hier anpassen:
```bash
less /etc/lvm/lvm.conf
```

- wird in unserem Beispiel nicht genauer betrachtet oder angepasst

# Aufbau einer Volume Group (VG) mit einem Volume

Physical Volume (PV) anlegen:
```bash
pvcreate /dev/vdb
```

Ergebnis prüfen:
```bash
pvdisplay -v /dev/vdb
```

Volume Group (VG) erzeugen:
```bash
vgcreate vg_demo /dev/vdb
```

Ergebnis prüfen:
```bash
vgdisplay -v vg_demo
```

Logical Volume (LV) erzeugen:
```bash
lvcreate -l 128 -n lv_home vg_demo
```

Ergebnis prüfen:
```bash
lvdisplay -v /dev/vg_demo/lv_home
```

Dateisystem anlegen:
```bash
mkfs -t ext4 /dev/vg_demo/lv_home
```

Dateisystem einhängen:
```bash
mount /dev/vg_demo/lv_home /home
```

Eintrag ins `/etc/fstab`:
```bash
/dev/vg_demo/lv_home /home ext4 errors=remount-ro 0 1
# vorzugsweise UUID verwenden
```

freien Platz prüfen:
```bash
df -h
```

# Erweiterung vom Logical Volume (LV)

- zunächst wieder in Root-Shell wechseln
- und den `/home`-Mount aushängen

Logical Volume (LV) vergrössern:
```bash
lvextend -l +100%FREE /dev/vg_demo/lv_home
```

Ergebnis prüfen:
```bash
lvdisplay -v /dev/vg_demo/lv_home
```

Dateisystem vergrössern:
```bash
resize2fs /dev/vg_demo/lv_home
```

nach dem Mount den freien Platz prüfen:
```bash
df -h
```

# Volume Group (VG) erweitern

neues PV anlegen:
```bash
pvcreate /dev/vdc
```

PV zur VG hinzufügen:
```bash
vgextend vg_demo /dev/vdc
```

LV erweitern:
```bash
lvextend -l 125 -r /dev/vg_demo/lv_home
```

Ergebnis prüfen:
```bash
lvdisplay -v /dev/vg_demo/lv_home
```

nach dem Mount den freien Platz prüfen:
```bash
df -h
```

# Elemente umbenennen

- oft wird bei LVM als Namenskonvention mit Präfixen gearbeitet
- die verwendeten sind `vg_` und `lv_`
- falls diese Konvention nicht erfüllt ist, bietet sich eine Umbenennung an

aktueller Zustand auf dem Beispiel-System (Debian) nach der Installation:
```bash
sudo vgs
  VG        #PV #LV #SN Attr   VSize VFree
  debian-vg   1   2   0 wz--n- 4.24g    0
  vg_demo     2   1   0 wz--n- 1.99g    0
sudo lvs
  LV      VG        Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root    debian-vg -wi-ao----   3.66g
  swap_1  debian-vg -wi-ao---- 596.00m
  lv_home vg_demo   -wi-ao----   1.99g
```

Umbenennung der VG:
```bash
sudo vgrename debian-vg vg_debian
```

Umbenennung der LVs:
```bash
sudo lvrename /dev/vg_debian/root /dev/vg_debian/lv_root
sudo lvrename /dev/vg_debian/swap_1 /dev/vg_debian/lv_swap
```

# Backups mit Snapshots

neue VG mit LV bereitstellen:
```bash
pvcreate /dev/vdd
vgcreate vg_snapshot /dev/vdd
lvcreate --name lv_daten -L 512M vg_snapshot
mkfs -t ext4 /dev/vg_snapshot/lv_daten
mount --mkdir /dev/vg_snapshot/lv_daten /mnt/daten
```

Daten in neuen Speicher übernehmen:
```bash
journalctl > /mnt/daten/journal
echo "*** LVM-TEST ***" >> /mnt/daten/journal
```

Snapshot erstellen:
```bash
lvcreate -L 128M --snapshot --name lv_snapshot /dev/vg_snapshot/lv_daten
```

Daten aus Snapshot und Original vergleichen:
```bash
mkdir ~/snapshot
mount /dev/vg_snapshot/lv_daten ~/snapshot
tail -1 /mnt/daten/journal
tail -1 ~/snapshot/journal
# alternativ sollte das hier keinen Unterschied ausgeben:
diff /mnt/daten/journal ~/snapshot/journal
```

Hinweise:

- Grösse des Snapshots begrenzt natürlich die Daten
- im Zweifel 100% der Grösse vom Original verwenden
- oft sind aber 20-30% ausreichend

verwendete Grösse analysieren:
```bash
lvs # zeigt origin und Data% an
lvdisplay -v /dev/vg_snapshot/lv_daten
```

weitere Daten im Original anhängen:
```bash
echo "*** ORIGINAL ***" >> /mnt/daten/journal
```

erneut vergleichen:
```bash
tail -1 /mnt/daten/journal
tail -1 ~/snapshot/journal
diff /mnt/daten/journal ~/snapshot/journal
```

Snapshot wieder löschen:
```bash
umount ~/snapshot
lvremove /dev/vg_snapshot/lv_snapshot
```

- gibt den Platz wieder frei

# Volume Group (VG) deaktivieren

VGs anzeigen:
```bash
vgs
```

LV aushängen:
```bash
umount /dev/vg_snapshot/lv_daten
```

VG entfernen:
```bash
vgremove vg_snapshot
# löscht VG und zugehöriges LV
```

entfernen der VGs überprüfen:
```bash
vgs # VG ist jetzt verschwunden
lvs # LV ist jetzt verschwunden
pvs # PV ist jetzt ungenutzt
```
